name: Demo Expiration Check

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check expiration date
        id: check_date
        run: |
          EXPIRATION_DATE=$(grep -oP 'EXPIRES:\s*\K\d{4}-\d{2}-\d{2}' deploy_all.sql | head -1)
          CURRENT_DATE=$(date -u +%Y-%m-%d)

          echo "Expiration date: $EXPIRATION_DATE"
          echo "Current date: $CURRENT_DATE"

          if [[ "$CURRENT_DATE" > "$EXPIRATION_DATE" ]] || [[ "$CURRENT_DATE" == "$EXPIRATION_DATE" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "expiration_date=$EXPIRATION_DATE" >> $GITHUB_OUTPUT
          else
            echo "expired=false" >> $GITHUB_OUTPUT
          fi

      - name: Create expiration notice issue
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          EXPIRATION_DATE: ${{ steps.check_date.outputs.expiration_date }}
        run: |
          EXISTING=$(gh issue list --label "expired" --state open --json number --jq '.[0].number' 2>/dev/null || true)
          if [ -n "$EXISTING" ]; then
            echo "Expiration issue #$EXISTING already exists, skipping"
            exit 0
          fi

          BODY=$(cat <<EOF
          This demo expired on **$EXPIRATION_DATE**.

          To extend, update the expiration date in \`deploy_all.sql\` and \`README.md\`.
          EOF
          )

          gh issue create \
            --title "Demo Expired" \
            --body "$BODY" \
            --label "expired"
