name: Archive Demo on Expiration

on:
  schedule:
    # Run daily at 00:00 UTC to check expiration
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check expiration date
        id: check_date
        run: |
          # Extract expiration date from deploy_all.sql
          EXPIRATION_DATE=$(grep -oP 'EXPIRES:\s*\K\d{4}-\d{2}-\d{2}' deploy_all.sql | head -1)
          CURRENT_DATE=$(date -u +%Y-%m-%d)
          
          echo "Expiration date: $EXPIRATION_DATE"
          echo "Current date: $CURRENT_DATE"
          
          if [[ "$CURRENT_DATE" > "$EXPIRATION_DATE" ]] || [[ "$CURRENT_DATE" == "$EXPIRATION_DATE" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "⚠️ Demo has expired!"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            echo "✅ Demo is still active"
          fi

      - name: Archive and make repository private
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ secrets.MASTER_PAT }}
        run: |
          # Archive the repository
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }} \
            -f archived=true \
            -F private=true

      - name: Add expiration notice
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ secrets.MASTER_PAT }}
        run: |
          # Create an issue documenting the expiration
          gh issue create \
            --title "Demo Expired - Repository Archived" \
            --body "This demo project expired on $(grep -oP 'EXPIRES:\s*\K\d{4}-\d{2}-\d{2}' deploy_all.sql | head -1) and has been automatically archived. The repository is now private and read-only." \
            --label "expired"

      - name: Notify on success
        if: steps.check_date.outputs.expired == 'true'
        run: |
          echo "✅ Repository archived successfully"
          echo "The demo has been archived and made private"
