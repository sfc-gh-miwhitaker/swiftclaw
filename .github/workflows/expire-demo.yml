name: Archive Demo on Expiration

on:
  schedule:
    # Run daily at 00:00 UTC to check expiration
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # Needed to archive repository
      issues: write      # Needed to create expiration issues
      repository-projects: write  # Needed to modify repository settings
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check expiration date
        id: check_date
        run: |
          # Extract expiration date from deploy_all.sql
          EXPIRATION_DATE=$(grep -oP 'EXPIRES:\s*\K\d{4}-\d{2}-\d{2}' deploy_all.sql | head -1)
          CURRENT_DATE=$(date -u +%Y-%m-%d)
          
          echo "Expiration date: $EXPIRATION_DATE"
          echo "Current date: $CURRENT_DATE"
          
          if [[ "$CURRENT_DATE" > "$EXPIRATION_DATE" ]] || [[ "$CURRENT_DATE" == "$EXPIRATION_DATE" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Demo has expired!"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Demo is still active"
          fi

      - name: Archive and make repository private
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ secrets.MASTER_PAT }}
        run: |
          echo "üîç Debugging information:"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          
          # Check if token is set
          if [ -z "$GH_TOKEN" ]; then
            echo "‚ùå ERROR: MASTER_PAT secret is not set or empty"
            exit 1
          else
            echo "‚úÖ MASTER_PAT secret is set (length: ${#GH_TOKEN})"
          fi
          
          # Test token permissions first
          echo "üîç Testing token permissions..."
          if ! gh api /repos/${{ github.repository }} --jq '.permissions' 2>&1; then
            echo "‚ùå Failed to read repository permissions"
            echo "Full error details:"
            gh api /repos/${{ github.repository }} 2>&1 || true
            exit 1
          fi
          
          # Archive the repository
          echo "üì¶ Attempting to archive repository..."
          if ! gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }} \
            -f archived=true \
            -F private=true 2>&1; then
            echo "‚ùå Failed to archive repository"
            echo "This usually means:"
            echo "1. Token lacks 'repo' scope"
            echo "2. Token owner doesn't have admin rights"
            echo "3. Token is expired or invalid"
            exit 1
          fi
          
          echo "‚úÖ Repository archived successfully"

      - name: Add expiration notice
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ secrets.MASTER_PAT }}
        run: |
          echo "üìù Creating expiration notice issue..."
          # Create an issue documenting the expiration
          if ! gh issue create \
            --title "Demo Expired - Repository Archived" \
            --body "This demo project expired on $(grep -oP 'EXPIRES:\s*\K\d{4}-\d{2}-\d{2}' deploy_all.sql | head -1) and has been automatically archived. The repository is now private and read-only." \
            --label "expired" 2>&1; then
            echo "‚ö†Ô∏è Failed to create issue (may be due to archived state)"
            echo "This is expected if repository was already archived"
          else
            echo "‚úÖ Expiration issue created"
          fi

      - name: Notify on success
        if: steps.check_date.outputs.expired == 'true'
        run: |
          echo "‚úÖ Repository archived successfully"
          echo "The demo has been archived and made private"
